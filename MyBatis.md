# MyBatis-Spring执行流程
1. 初始化Mapper和解析XML和SQL
   - SqlSessionFactoryBean的初始化方法afterPropertiesSet会构建实际的SqlSessionFactory实例,构建过程中会解析所有XML和注解SQL
   - 构建过程中还会使用MapperRegistry的addMapper方法为每个Mapper实例化一个MapperProxyFactory并且生成SQL的MappedStatement
     - 另外：在mybatis-plus中自带的getById等方法就是用MybatisConfiguration代替了mybatis的Configuration来调用addMapper方法使用MybatisMapperRegistry的addMapper方法注入自定义SQL方法实现没有XML也有固定的方法可以使用
   - 容器启动时AutoConfiguredMapperScannerRegistrar使用ClassPathMapperScanner扫描所有Mapper注解的类为BeanDefinition并且设置beanClass为MapperFactoryBean.class
2. 获取Mapper对象
   - MapperFactoryBean的父类中有个属性sqlSession内容为SqlSessionTemplate,实际获取Mapper的bean时就通过MapperFactoryBean的getObject方法调用SqlSessionTemplate的getMapper方法最终调用MapperRegistry的getMapper方法获取到SqlSessionFactory实例化时注册的MapperProxyFactory来newInstance一个JDK动态代理,代理的接口是Mapper,执行InvocationHandler为MapperProxy,MapperProxy的invoke方法会调用MapperMethod的execute方法通过SqlSession实际执行SQL
3. 执行方法
   - 执行Mapper方法时通过SqlSessionTemplate中的sqlSessionProxy来进行的,sqlSessionProxy是一个在SqlSessionTemplate构造方法中生成的JDK动态代理,接口为SqlSession,InvocationHandler为SqlSessionInterceptor,invoke方法中会获取DefaultSqlSession来实际执行方法,这样是为了处理事务问题
     - SqlSessionTemplate实际上就是使用了静态代理模式对查询操作进行了增强,实际操作还是DefaultSqlSession在执行
   - 在DefaultSqlSession中的方法执行都是调用的Executor的query/update两个方法,因为2级缓存默认是开启的(cacheEnabled)所以默认的Executor就是CachingExecutor,这是通过装饰器模式对BaseExecutor增强的执行器,增强的内容就是二级缓存,所有缓存内容都是先存放事务缓存管理器的临时暂存区,暂存区根据命名空间区分,每个命名空间有自己的暂存区,代码实现就是Map,提交时再刷新到二级缓存
   - 如果未命中二级缓存则调用BaseExecutor的query/update方法来执行,BaseExecutor是一个抽象类,其实现有SimpleExecutor、ReuseExecutor、BatchExecutor,执行query/update时使用模板方法模式调用实现类的doQuery和doUpdate方法,BaseExecutor的主要作用是统一管理一级缓存
   - 在Executor的doQuery和dpUpdate方法中实际使用StatementHandler来最终执行query/update,流程为prepare(创建Statement)、parameterize(设置参数)、query/update(执行)
     - StatementHandler是一个接口,其实现也是通过模板方法模式,BaseStatementHandler是抽象模板,提供统一操作的抽象,最终实现有SimpleStatementHandler、PreparedStatementHandler、CallableStatementHandler
     - Executor在构建StatementHandler时时通过Configuration的newStatementHandler方法来完成的,会先new一个RoutingStatementHandler作为装饰器,构造方法中根据MappedStatement的getStatementType值来判断装饰的实际StatementHandler并且创建出来
     - 第一步在BaseStatementHandler的prepare方法中调用子类的instantiateStatement方法创建实际的Statement
     - 第二步调用子类的parameterize方法使用ParameterHandler来设置参数
     - 第三步调用子类的query/update最终执行Statement的execute方法完成SQL的执行并且调用ResultSetHandler来处理结果结果集返回
